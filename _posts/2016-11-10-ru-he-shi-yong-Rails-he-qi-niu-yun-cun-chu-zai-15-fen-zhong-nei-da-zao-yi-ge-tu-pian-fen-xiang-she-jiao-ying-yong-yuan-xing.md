---
layout:     post
title:      "如何使用 Rails 和七牛云存储，在 15 分钟内打造一个图片分享社交应用原型"
date:       2016-11-10 04:00:34 UTC
author:     "baicai"
catalog: true
tags:
    - 存档
---

<div id="content">
<p><video poster="http://7xp2m5.com2.z0.glb.qiniucdn.com/%22Pinterest%22%20with%20Qiniu%20and%20Rails%20in%2015%20minutes.png" controls="" preload="metadata" height="500" width="600"></video><source type="video/mp4; codecs="avc1.42E01E, mp4a.40.2"" src="http://7xp2m5.com2.z0.glb.qiniucdn.com/%22Pinterest%22%20with%20Qiniu%20and%20Rails%20in%2015%20minutes.mp4"></p>
<p>十年前，Web 应用框架 Rails 创始人 David Heinemeier Hansson 曾录制视频，向我们演示如何使用 Ruby on Rails 在 15 分钟内创作一个 blog 引擎。这个视频通过 Rails 优秀的 MVC 、习惯优于配置（Convention over Configuration）等设计，以及强大的代码生成、scaffold 等功能，成功展示了 Ruby on Rails 编写 Web 应用核心功能的高效简洁。Ruby on Rails 这门技术也在 Web 2.0 时代大放异彩，成为了 Web 应用开发最佳的技术方案选择之一。&lt;/p>
<p>经过十年的发展，软件行业早已迈入云计算时代。为了应对大规模的访问量，同时控制研发和运营成本，作为云计算基石的云存储，已经成为了 Web 开发必不可少的基础设施。今天，就让我们一起来看看如何使用 Rails 和七牛云存储，在 15 分钟内打造一个图片分享社交应用原型。&lt;/p>
<p><a rel="nofollow" target="_blank" href="http://www.qiniu.com">七牛云存储&lt;/a> 是一个公有云服务，提供海量对象存储功能，以及云端文件处理和分发服务。开始之前，我们需要创建一个七牛云存储 <a rel="nofollow" target="_blank" href="https://portal.qiniu.com/signup">试用帐户</a>，并且了解一些基础知识：&lt;/p>
<p>七牛云存储是一个 Key-Value 形式的对象存储系统，一个 key 对应一个资源（文件）。&lt;br>
资源必须存储在某个空间（Bucket）中，不可单独存在。一个帐户可以创建多个空间。&lt;/p>
<p>创建基本 Rails 项目</p>
<p>你应该可以使用 Ruby 1.9 以上，Rails 3.0 以上的任意版本，本例中我们使用的是 Ruby 2.2.3 和 Rails 4.2.5。&lt;/p>
<p>安装好 Ruby 和 Rails 之后，使用 rails 命令创建应用程序 konata 的目录结构和基本文件：&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="48115" class="copybut" id="copybut48115" onclick="doCopy('code48115')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code48115"><br>
rails new konata<br>
</div><br>
稍候这条命令执行完成，我们立即得到了一个可以运行的空白 Rails 应用程序，执行以下命令，并在浏览器中访问 http://localhost:3000 查看运行效果：&lt;p></p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="39829" class="copybut" id="copybut39829" onclick="doCopy('code39829')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code39829"><br>
cd konata<br>
rails server<br>
</div><p></p>
<p>使用 Rails Scaffold 实现 CRUD</p>
<p>我们将使用 Rails 的 scaffold 功能，生成用于处理图片发表的 model、controller、view，以及 database migration 等源代码文件。&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="17802" class="copybut" id="copybut17802" onclick="doCopy('code17802')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code17802"><br>
rails generate scaffold post title filename qiniu_hash<br>
rake db:migrate<br>
</div><br>
访问 http://localhost:3000/posts 可以看到，我们已经获得了 post 的完整 CRUD 功能，只是暂时还不能上传图片。&lt;p></p>
<p>使用七牛 API 实现图片上传</p>
<p>修改 Gemfile，在其中加入对七牛 Ruby SDK 的引用：</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="57323" class="copybut" id="copybut57323" onclick="doCopy('code57323')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code57323"><br>
gem 'qiniu'<br>
</div><p></p>
<p>执行以下命令安装七牛 Ruby SDK。这里原本应该执行 bundle 进行安装，但由于七牛 Ruby SDK 依赖的 mime-types 版本设定比较保守，需要使用 bundle update 命令降级 mime-types，解决依赖冲突。&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="38761" class="copybut" id="copybut38761" onclick="doCopy('code38761')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code38761"><br>
bundle update mime-types<br>
</div><p></p>
<p>编辑 config/secrets.yml，在其中加入七牛云存储帐户的密钥：&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="21007" class="copybut" id="copybut21007" onclick="doCopy('code21007')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code21007"><br>
development:<br>
secret_key_base: &lt;YOUR_SECRET_KEY_BASE&gt;<br>
qiniu_access_key: &lt;YOUR_QINIU_ACCESS_KEY&gt;<br>
qiniu_secret_key: &lt;YOUR_QINIU_SECRET_KEY&gt;<br>
</div><p></p>
<p>创建 config/initializers/qiniu.rb，使用刚才加入的密钥与七牛云存储服务器建立连接。内容如下：</p>
<div class="jb51code">
<div><div id="highlighter_198413" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">require </code><code class="ruby string">'qiniu'</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby plain">Qiniu.establish_connection!(</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">access_key: Rails.application.secrets.qiniu_access_key,</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">secret_key: Rails.application.secrets.qiniu_secret_key</code></div><div class="line number6 index5 alt1"><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><strong>注意：&lt;/strong></p>
<p>AccessKey 和 SecretKey 必须绝对保密，不可出现在用户可以查看的 Web 前端源代码里，或是编译进客户端二进制代码中。&lt;/p>
<p>七牛 API 提供了&lt;a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/up/upload-models/upload-types.html">多种上传方式</a> 以满足不同的业务场景需求。这里我们选择使用最有代表性，也最简单的 HTML 表单上传＋HTTP 303 重定向返回的方式实现客户端文件直接上传七牛云存储。这种方法的好处是客户端文件无需通过业务服务器（app server）中转，既可以利用七牛强大的 CDN 优化上传速度及提高可靠性，也可以节省业务服务器带宽。&lt;/p>
<p>编辑 app/views/posts/_form.html.erb，根据七牛云存储 SDK 构造上传表单。注意其中的上传凭证字段，我们将在 PostsController 里创建它：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_815415" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;%= form_tag </code><code class="ruby string">'<a href="http://upload.qiniu.com">http://upload.qiniu.com</a>'</code><code class="ruby plain">, multipart: </code><code class="ruby keyword">true</code> <code class="ruby keyword">do</code> <code class="ruby plain">%&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= hidden_field_tag </code><code class="ruby color2">:token</code><code class="ruby plain">, </code><code class="ruby variable bold">@qiniu_upload_token</code> <code class="ruby plain">%&gt;</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"field"</code><code class="ruby plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= label_tag </code><code class="ruby color2">:title</code> <code class="ruby plain">%&gt;&lt;br&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= text_field_tag </code><code class="ruby string">'x:title'</code> <code class="ruby plain">%&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/div&gt;</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"field"</code><code class="ruby plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= label_tag </code><code class="ruby color2">:image</code> <code class="ruby plain">%&gt;&lt;br&gt;</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= file_field_tag </code><code class="ruby color2">:file</code> <code class="ruby plain">%&gt;</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/div&gt;</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"actions"</code><code class="ruby plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= submit_tag </code><code class="ruby string">'Create'</code> <code class="ruby plain">%&gt;</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/div&gt;</code></div><div class="line number15 index14 alt2"><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>编辑 app/controllers/posts_controller.rb，添加代码生成上传凭证，以及根据七牛云存储自定义响应内容创建 post 实例：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_708779" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">def</code> <code class="ruby keyword">new</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@qiniu_upload_token</code> <code class="ruby plain">= generate_qiniu_upload_token</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.</code><code class="ruby keyword">new</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">create</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">upload_ret = </code><code class="ruby constants">JSON</code><code class="ruby plain">.parse(Base64.urlsafe_decode64(params[</code><code class="ruby color2">:upload_ret</code><code class="ruby plain">]))</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.</code><code class="ruby keyword">new</code><code class="ruby plain">(</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">title: upload_ret[</code><code class="ruby string">'title'</code><code class="ruby plain">],</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">filename: upload_ret[</code><code class="ruby string">'fname'</code><code class="ruby plain">],</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">qiniu_hash: upload_ret[</code><code class="ruby string">'hash'</code><code class="ruby plain">]</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">)</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby comments"># ...</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">private</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">generate_qiniu_upload_token</code></div><div class="line number19 index18 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">put_policy = Qiniu::Auth::PutPolicy.</code><code class="ruby keyword">new</code><code class="ruby plain">(</code><code class="ruby string">'konata'</code><code class="ruby plain">)</code></div><div class="line number20 index19 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">put_policy.return_body = {</code></div><div class="line number21 index20 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">fname: </code><code class="ruby string">'$(fname)'</code><code class="ruby plain">,</code></div><div class="line number22 index21 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">hash: </code><code class="ruby string">'$(etag)'</code><code class="ruby plain">,</code></div><div class="line number23 index22 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">title: </code><code class="ruby string">'$(x:title)'</code></div><div class="line number24 index23 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">}.to_json</code></div><div class="line number25 index24 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">put_policy.return_url = create_posts_url</code></div><div class="line number26 index25 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">Qiniu::Auth.generate_uptoken(put_policy)</code></div><div class="line number27 index26 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>编辑 config/routes.rb，将 create action 定义为使用 get 方法亦可访问:</p>
<div class="jb51code">
<div><div id="highlighter_703367" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby plain">collection </code><code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby plain">get </code><code class="ruby string">'create'</code><code class="ruby plain">, as: </code><code class="ruby color2">:create</code></div><div class="line number4 index3 alt1"><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>重新启动 rails server，访问 http://localhost:3000/posts/new，现在我们已经可以在发表新 post 的时候上传图片至七牛云存储。&lt;/p>
<p><strong>提示：&lt;/strong></p>
<p>文件将会上传到名为 konata 的公开空间（bucket）。&lt;br>
我们没有在代码中指定 key，七牛云存储默认会使用根据文件内容计算的 hash (etag) 值做为 key。这种做法可以非常简单地避免内容相同的文件存储多份浪费空间。&lt;br>
由于上传表单将会直接提交到七牛云存储服务器，我们的应用程序后端无法获得 title 等业务对象字段，我们使用七牛云存储 API 的 <a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/up/response/vars.html#xvar">自定义变量&lt;/a> 和 <a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/up/response/response-body.html">自定义响应内容&lt;/a> 功能，通过七牛云存储上传 API 中转获得这些字段。&lt;br>
展示用户上传的图片&lt;/p>
<p>修改 app/helpers/application_helper.rb，添加 qiniu_image_url 方便生成图片 URL。为了保持简单我们直接硬编码了空间的域名：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_736409" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">def</code> <code class="ruby plain">qiniu_image_url(post, format = </code><code class="ruby color2">:raw</code><code class="ruby plain">)</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url = </code><code class="ruby string">"<a href="http://7xokus.com2.z0.glb.qiniucdn.com/">http://7xokus.com2.z0.glb.qiniucdn.com/</a>#{post.qiniu_hash}"</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">case</code> <code class="ruby plain">format</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">when</code> <code class="ruby color2">:square</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url &lt;&lt; </code><code class="ruby string">'?imageView2/1/w/300/h/300/q/90'</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">when</code> <code class="ruby color2">:preview</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url &lt;&lt; </code><code class="ruby string">'?imageView2/2/w/1000/h/1000/q/90'</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">when</code> <code class="ruby color2">:raw</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url &lt;&lt; </code><code class="ruby string">"?attname=#{post.filename}"</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">else</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>修改 app/views/posts/index.html.erb 和 app/views/posts/show.html.erb，调用刚才创建的 URL helper 展示图片：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_922931" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;tr&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;td&gt;&lt;%= post.title %&gt;&lt;/td&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;td&gt;&lt;%= link_to image_tag(qiniu_image_url(post, </code><code class="ruby color2">:square</code><code class="ruby plain">), size: </code><code class="ruby string">'300'</code><code class="ruby plain">), post %&gt;&lt;/td&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;td&gt;&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;&lt;/td&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/tr&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="jb51code">
<div><div id="highlighter_881342" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;p&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to image_tag(qiniu_image_url(</code><code class="ruby variable bold">@post</code><code class="ruby plain">, </code><code class="ruby color2">:preview</code><code class="ruby plain">)), qiniu_image_url(</code><code class="ruby variable bold">@post</code><code class="ruby plain">), </code><code class="ruby keyword">class</code><code class="ruby plain">: </code><code class="ruby string">'image'</code> <code class="ruby plain">%&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby plain">&lt;/p&gt;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Back'</code><code class="ruby plain">, posts_path %&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>修改 config/routes.rb，将网站根目录设置为 posts 列表页面：&lt;/p>
<p><br>
root 'posts#index'<br>
访问 http://localhost:3000，现在我们可以看到刚才上传的图片。&lt;/p>
<p><strong>提示：&lt;/strong></p>
<p>每个空间（bucket）内的资源都可以通过该空间的默认或自定义域名，加上文件 key 构造的 HTTP URL 进行访问。&lt;br>
可以在 URL 后增加特定查询参数，调用七牛云存储强大的 <a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/fop/">数据处理（Fop）&lt;/a> API，实时生成自定义格式的缩略图。&lt;br>
可以通过查询参数 attname 指定 URL 下载时使用的文件名。&lt;br>
<strong>简单的 UI 美化</strong></p>
<p>修改 app/views/posts/index.html.erb，将原有的 table 布局改为 flexbox 布局：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_614870" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"posts"</code><code class="ruby plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby variable bold">@posts</code><code class="ruby plain">.</code><code class="ruby keyword">each</code> <code class="ruby keyword">do</code> <code class="ruby plain">|post| %&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;p&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to image_tag(qiniu_image_url(post, </code><code class="ruby color2">:square</code><code class="ruby plain">), size: </code><code class="ruby string">'300'</code><code class="ruby plain">), post, </code><code class="ruby keyword">class</code><code class="ruby plain">: </code><code class="ruby string">'image'</code> <code class="ruby plain">%&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= post.title %&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/p&gt;</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div><div class="line number11 index10 alt2"><code class="ruby plain">&lt;/div&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>修改 app/assets/stylesheets/application.css，加入对应的 CSS：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_953932" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">body {</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">padding: 20px;</code></div><div class="line number3 index2 alt2"><code class="ruby plain">}</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">a.image</code><code class="ruby color2">:hover</code> <code class="ruby plain">{</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">background-color: transparent;</code></div><div class="line number7 index6 alt2"><code class="ruby plain">}</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="ruby plain">div.posts {</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">display: flex;</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">flex-flow: row wrap;</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">justify-content: space-between;</code></div><div class="line number13 index12 alt2"><code class="ruby plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>访问 http://localhost:3000，图片列表看起来像一个正常的相册了。&lt;/p>
<p><strong>添加用户账户功能</strong></p>
<p>我们的应用程序还有两个明显的问题：没有记录图片是由谁分享的；任何人都可以删除 post。这对于一个社交应用来说显然是不能接受的问题。这对于一个社交应用来说显然是不可接受的，所以接下来我们将使用 Rails 社区流行的 Devise 组件直接获得用户注册、登录、验证子系统，实现图片发表者信息记录等功能。&lt;/p>
<p>修改 Gemfile，加入对 Devise 的依赖：</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="47710" class="copybut" id="copybut47710" onclick="doCopy('code47710')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code47710"><br>
gem 'devise'<br>
</div><p></p>
<p>执行以下命令安装 Devise，生成 User model，以及我们所需的 data migration：&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="67600" class="copybut" id="copybut67600" onclick="doCopy('code67600')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code67600"><br>
bundle<br>
rails generate devise:install<br>
rails generate devise user<br>
rails generate migration add_author_to_posts creator:belongs_to<br>
rake db:migrate<br>
</div><p></p>
<p>修改 app/controllers/posts_controller.rb，对查看以外的操作要求登录，并在发表 post 时记录发表者身份：</p>
<div class="jb51code">
<div><div id="highlighter_134512" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">before_action </code><code class="ruby color2">:authenticate_user</code><code class="ruby plain">!, except: [</code><code class="ruby color2">:index</code><code class="ruby plain">, </code><code class="ruby color2">:show</code><code class="ruby plain">]</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby keyword">def</code> <code class="ruby plain">create</code></div><div class="line number4 index3 alt1"><code class="ruby comments"># ...</code></div><div class="line number5 index4 alt2"><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.</code><code class="ruby keyword">new</code><code class="ruby plain">(</code></div><div class="line number6 index5 alt1"><code class="ruby plain">title: upload_ret[</code><code class="ruby string">'title'</code><code class="ruby plain">],</code></div><div class="line number7 index6 alt2"><code class="ruby plain">filename: upload_ret[</code><code class="ruby string">'fname'</code><code class="ruby plain">],</code></div><div class="line number8 index7 alt1"><code class="ruby plain">qiniu_hash: upload_ret[</code><code class="ruby string">'hash'</code><code class="ruby plain">],</code></div><div class="line number9 index8 alt2"><code class="ruby plain">creator: current_user</code></div><div class="line number10 index9 alt1"><code class="ruby plain">)</code></div><div class="line number11 index10 alt2"><code class="ruby comments"># ...</code></div><div class="line number12 index11 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>修改 app/models/post.rb，添加与 User model 的从属关联：</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="34488" class="copybut" id="copybut34488" onclick="doCopy('code34488')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code34488"><br>
belongs_to :creator, class_name: 'User'<br>
</div><br>
修改 app/views/layouts/application.html.erb，添加登录状态信息和注销链接：&lt;p></p>
<div class="jb51code">
<div><div id="highlighter_578041" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;header&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">user_signed_in? %&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby plain">&lt;p&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby plain">Hello &lt;%= current_user.email %&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Logout'</code><code class="ruby plain">, destroy_user_session_path, method: </code><code class="ruby color2">:delete</code> <code class="ruby plain">%&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby plain">&lt;/p&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div><div class="line number8 index7 alt1"><code class="ruby plain">&lt;/header&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>修改 app/views/posts/index.html.erb，限制仅 post 发表者可以删除该 post：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_177805" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">user_signed_in? </code><code class="ruby keyword">and</code> <code class="ruby plain">post.creator == current_user %&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>重启 rails server 后，访问 <a rel="nofollow" href="http://localhost:3000">http://localhost:3000</a>，现在用户需要注册登录才能发表图片了。&lt;/p>
<p>实现点赞功能</p>
<p>最后，做为一个社交应用，没有点赞功能怎么能让点赞狂魔们满足呢？！我们将添加一个 like scaffold 用来处理点赞和存储点赞信息。&lt;/p>
<p>执行以下命令生成 scaffold，Like model 将做为一个 join model 同时从属于 Post 和 User：&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="33824" class="copybut" id="copybut33824" onclick="doCopy('code33824')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code33824"><br>
rails generate scaffold like post:belongs_to user:belongs_to<br>
rake db:migrate<br>
</div><p></p>
<p>修改 app/models/post.rb，建立 Post 与 Like model 的“拥有／嵌套”关系：</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="9257" class="copybut" id="copybut9257" onclick="doCopy('code9257')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code9257"><br>
has_many :likes<br>
</div><br>
修改 app/models/like.rb，限制一个点赞狂魔对一个 post 只能点一次赞：&lt;p></p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="82959" class="copybut" id="copybut82959" onclick="doCopy('code82959')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code82959"><br>
validates_uniqueness_of :user, scope: :post<br>
</div><br>
修改 config/routes.rb，将 likes 设置为 posts 的嵌套资源：<p></p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="35297" class="copybut" id="copybut35297" onclick="doCopy('code35297')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code35297"><br>
resources :posts do<br>
# ...<br>
resources :likes<br>
end<br>
</div><br>
修改 app/views/posts/index.html.erb，添加点赞信息显示以及 AJAX 点赞链接：&lt;p></p>
<div class="jb51code">
<div><div id="highlighter_71392" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;%= post.title %&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= content_tag(</code><code class="ruby color2">:span</code><code class="ruby plain">, </code><code class="ruby string">"#{post.likes.count} likes"</code><code class="ruby plain">, id: </code><code class="ruby string">"post_#{post.id}_likes"</code><code class="ruby plain">) %&gt;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">user_signed_in? %&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Like'</code><code class="ruby plain">, post_likes_path(post), method: </code><code class="ruby color2">:post</code><code class="ruby plain">, remote: </code><code class="ruby keyword">true</code> <code class="ruby plain">%&gt;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">post.creator == current_user %&gt;</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>修改 app/controllers/likes_controller.rb，真正将 likes 资源实现为 posts 的嵌套资源，并在点赞时记录点赞狂魔的身份：&lt;/p>
<div class="jb51code">
<div><div id="highlighter_500953" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">before_action </code><code class="ruby color2">:set_post</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">create</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@like</code> <code class="ruby plain">= </code><code class="ruby variable bold">@post</code><code class="ruby plain">.likes.</code><code class="ruby keyword">new</code><code class="ruby plain">(user: current_user)</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">respond_to </code><code class="ruby keyword">do</code> <code class="ruby plain">|format|</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">if</code> <code class="ruby variable bold">@like</code><code class="ruby plain">.save</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">format.js { }</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">else</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">format.js { }</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">private</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">set_post</code></div><div class="line number18 index17 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.find(params[</code><code class="ruby color2">:post_id</code><code class="ruby plain">])</code></div><div class="line number19 index18 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>创建 app/views/likes/create.js.erb，使用 Server-generated JavaScript 更新点赞信息：&lt;/p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="78282" class="copybut" id="copybut78282" onclick="doCopy('code78282')"><u>复制代码</u></a></span> 代码如下:</div><div class="codebody" id="code78282"><br>
$("#&lt;%= "post_#{@post.id}_likes" %&gt;").text("&lt;%= "#{@post.likes.count} likes" %&gt;")<br>
</div><br>
重启 rails server 后，访问 http://localhost:3000，让我们愉快地点赞吧～&lt;p></p>
<p><strong>小结</strong></p>
<p>虽然这只是一个简单的原型，但是因为使用了七牛云存储作为图片存储后端，我们的社交应用产品在一开始的原型阶段就拥有了能为大规模用户提供高速、可靠服务的潜能。&lt;/p>
<p>简单回顾一下我们刚才学习到的内容吧。使用 Rails 的代码生成功能， 基于 CRUD 结构的 scaffold 实现业务对象维护，以及业务操作非常高效；使用七牛云存储则可以轻松处理业务系统中的文件存储，获得图片视频等多媒体文件的云端处理能力，减少，甚至避免了部分研发和运维工作。希望这个视频可以帮助大家认识这两个优秀的开发工具，直观感受到它们的高效强大和简单易用。&lt;/p>
<p><strong>参考资料&lt;/strong></p>
<p><a rel="nofollow" target="_blank" href="http://guides.rubyonrails.org/">Ruby on Rails Guides</a><br>
<a rel="nofollow" target="_blank" href="http://developer.qiniu.com/">七牛开发者中心&lt;/a></p>
<p><strong>示例代码</strong></p>
<p><a rel="nofollow" target="_blank" href="https://github.com/rainux/konata-sample">https://github.com/rainux/konata-sample</a></p>
<p>比起直接试用示例代码，你应该按照教程自己编写这些代码，亲自编写代码有助于加深理解和记忆。&lt;/p>

</div>